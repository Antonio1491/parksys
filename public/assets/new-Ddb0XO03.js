import{d9 as U,da as m,db as K,aH as Q,az as z,a4 as P,aA as O,u as C,ar as H,R as S,j as e,bh as _,B as w,A as G,f as J,g as W,h as Y,b5 as A,i as X,aI as Z,aJ as t,aK as o,aL as c,aM as l,V as p,aN as d,W as h,Y as j,_ as g,$ as b,a0 as x,a1 as ee,Q as ae,cE as se,cp as ne,aB as ie,aC as re,cV as L}from"./index-BKCBrrzQ.js";const te=U({title:m().min(1,"El tÃ­tulo es obligatorio"),description:m().min(10,"La descripciÃ³n debe tener al menos 10 caracteres"),priority:K(["low","medium","high","critical"]),categoryId:m().min(1,"La categorÃ­a es obligatoria"),assetId:m().optional(),parkId:m().min(1,"El parque es obligatorio"),location:m().optional(),reportedBy:m().min(1,"El responsable del reporte es obligatorio"),contactInfo:m().optional()}),de=()=>{var D,E;const[oe,v]=Q(),q=z(),[T,k]=P.useState(new Date),n=new URLSearchParams(window.location.search).get("assetId"),i=O({resolver:ie(te),defaultValues:{title:"",description:"",priority:"medium",categoryId:"",assetId:n||"",parkId:"",location:"",reportedBy:"",contactInfo:""}}),{data:f=[]}=C({queryKey:["/api/parks"],retry:!1}),{data:I=[]}=C({queryKey:["/api/assets"],retry:!1}),{data:y=[]}=C({queryKey:["/api/incident-categories"],retry:!1}),N=H({mutationFn:async a=>{const s={title:a.title,description:a.description,assetId:a.assetId&&a.assetId!=="none"?parseInt(a.assetId):null,parkId:parseInt(a.parkId),categoryId:parseInt(a.categoryId),severity:a.priority,location:a.location,reporterName:a.reportedBy,reporterEmail:a.contactInfo,status:"pending"};return console.log("ðŸ“ Datos del formulario a enviar:",a),console.log("ðŸ“ Datos procesados para envÃ­o:",s),re("/api/incidents",{method:"POST",data:s})},onSuccess:()=>{L({title:"Incidencia creada",description:"La incidencia ha sido reportada exitosamente."}),q.invalidateQueries({queryKey:["/api/incidents"]}),v("/admin/incidents")},onError:a=>{L({title:"Error",description:a.message||"No se pudo crear la incidencia.",variant:"destructive"})}}),M=a=>{N.mutate(a)},$=[{id:1,name:"Mantenimiento",description:"Problemas de mantenimiento general"},{id:2,name:"Seguridad",description:"Incidentes de seguridad"},{id:3,name:"Limpieza",description:"Problemas de limpieza"},{id:4,name:"Infraestructura",description:"DaÃ±os en infraestructura"},{id:5,name:"Vandalismo",description:"Actos de vandalismo"}],B=S.useMemo(()=>(y.length>0?y:$).filter(s=>s&&s.id&&s.name&&s.name.trim()!==""&&s.id.toString().trim()!==""),[y]),V=S.useMemo(()=>Array.isArray(f)?f.filter(a=>a&&a.id&&a.name&&a.name.trim()!==""&&a.id.toString().trim()!==""):[],[f]),u=S.useMemo(()=>Array.isArray(I)?I.filter(a=>a&&a.id&&a.name&&a.name.trim()!==""&&a.id.toString().trim()!==""):[],[I]),R=B;return P.useEffect(()=>{var a;if(n&&u.length>0){const s=u.find(r=>r.id===parseInt(n));if(s){i.setValue("assetId",n),i.setValue("parkId",((a=s.parkId)==null?void 0:a.toString())||"");let r="";if(s.locationDescription&&s.locationDescription.trim()&&(r=s.locationDescription.trim()),s.latitude&&s.longitude){const F=`${parseFloat(s.latitude).toFixed(6)}, ${parseFloat(s.longitude).toFixed(6)}`;r=r?`${r} (Coordenadas: ${F})`:`Coordenadas: ${F}`}r||(r=`Ãrea del activo: ${s.name}`),i.setValue("location",r),console.log("ðŸŽ¯ Datos del activo cargados automÃ¡ticamente:",{assetId:s.id,assetName:s.name,parkId:s.parkId,location:r,coordinates:s.latitude&&s.longitude?`${s.latitude}, ${s.longitude}`:"No disponibles"})}}},[n,u,i]),e.jsx(_,{children:e.jsxs("div",{className:"max-w-4xl mx-auto p-6",children:[e.jsx("div",{className:"flex items-center gap-4 mb-6",children:e.jsxs(w,{variant:"ghost",onClick:()=>v("/admin/incidents"),className:"flex items-center gap-2",children:[e.jsx(G,{className:"h-4 w-4"}),"Volver a Incidencias"]})}),e.jsxs(J,{children:[e.jsx(W,{children:e.jsxs(Y,{className:"flex items-center gap-2",children:[e.jsx(A,{className:"h-5 w-5 text-orange-500"}),"Reportar Nueva Incidencia"]})}),e.jsxs(X,{children:[n&&e.jsx("div",{className:"mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-1 bg-blue-100 rounded",children:e.jsx(A,{className:"h-4 w-4 text-blue-600"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium text-blue-900 mb-1",children:"Formulario configurado automÃ¡ticamente"}),e.jsx("p",{className:"text-sm text-blue-700 mb-2",children:"Los campos de activo, parque y ubicaciÃ³n se han completado automÃ¡ticamente basÃ¡ndose en el activo seleccionado desde el inventario."}),e.jsxs("div",{className:"text-xs text-blue-600 space-y-1",children:[e.jsxs("div",{children:["â€¢ ",e.jsx("strong",{children:"Activo:"})," ",((D=u.find(a=>a.id===parseInt(n)))==null?void 0:D.name)||"Cargando..."]}),e.jsxs("div",{children:["â€¢ ",e.jsx("strong",{children:"Parque:"})," ",((E=V.find(a=>a.id===parseInt(i.watch("parkId"))))==null?void 0:E.name)||"Cargando..."]}),e.jsxs("div",{children:["â€¢ ",e.jsx("strong",{children:"UbicaciÃ³n:"})," Incluye coordenadas precisas del activo"]})]})]})]})}),e.jsx(Z,{...i,children:e.jsxs("form",{onSubmit:i.handleSubmit(M),className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(t,{control:i.control,name:"title",render:({field:a})=>e.jsxs(o,{children:[e.jsx(c,{children:"TÃ­tulo de la Incidencia"}),e.jsx(l,{children:e.jsx(p,{placeholder:"Ej: DaÃ±o en resbaladilla",...a})}),e.jsx(d,{})]})}),e.jsx(t,{control:i.control,name:"priority",render:({field:a})=>e.jsxs(o,{children:[e.jsx(c,{children:"Prioridad"}),e.jsxs(h,{onValueChange:a.onChange,defaultValue:a.value,children:[e.jsx(l,{children:e.jsx(j,{children:e.jsx(g,{placeholder:"Seleccionar prioridad"})})}),e.jsxs(b,{children:[e.jsx(x,{value:"low",children:"Baja"}),e.jsx(x,{value:"medium",children:"Media"}),e.jsx(x,{value:"high",children:"Alta"}),e.jsx(x,{value:"critical",children:"CrÃ­tica"})]})]}),e.jsx(d,{})]})}),e.jsx(t,{control:i.control,name:"categoryId",render:({field:a})=>e.jsxs(o,{children:[e.jsx(c,{children:"CategorÃ­a"}),e.jsxs(h,{onValueChange:a.onChange,defaultValue:a.value,children:[e.jsx(l,{children:e.jsx(j,{children:e.jsx(g,{placeholder:"Seleccionar categorÃ­a"})})}),e.jsx(b,{children:R.map(s=>e.jsx(x,{value:s.id.toString(),children:s.name},s.id))})]}),e.jsx(d,{})]})}),e.jsx(t,{control:i.control,name:"parkId",render:({field:a})=>e.jsxs(o,{children:[e.jsxs(c,{className:"flex items-center gap-2",children:["Parque",n&&e.jsx("span",{className:"text-xs bg-green-100 text-green-700 px-2 py-1 rounded",children:"Cargado automÃ¡ticamente"})]}),e.jsxs(h,{onValueChange:a.onChange,defaultValue:a.value,disabled:!!n,children:[e.jsx(l,{children:e.jsx(j,{className:n?"bg-gray-50 cursor-not-allowed":"",children:e.jsx(g,{placeholder:"Seleccionar parque"})})}),e.jsx(b,{children:V.map(s=>e.jsx(x,{value:s.id.toString(),children:s.name},s.id))})]}),n&&e.jsx("p",{className:"text-xs text-gray-600",children:"El parque se cargÃ³ automÃ¡ticamente desde el activo seleccionado"}),e.jsx(d,{})]})}),u.length>0&&e.jsx(t,{control:i.control,name:"assetId",render:({field:a})=>e.jsxs(o,{children:[e.jsxs(c,{className:"flex items-center gap-2",children:["Activo Relacionado ",n?"":"(Opcional)",n&&e.jsx("span",{className:"text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded",children:"Preseleccionado"})]}),e.jsxs(h,{onValueChange:a.onChange,defaultValue:a.value,disabled:!!n,children:[e.jsx(l,{children:e.jsx(j,{className:n?"bg-gray-50 cursor-not-allowed":"",children:e.jsx(g,{placeholder:"Seleccionar activo"})})}),e.jsxs(b,{children:[e.jsx(x,{value:"none",children:"Sin activo especÃ­fico"}),u.map(s=>e.jsx(x,{value:s.id.toString(),children:s.name},s.id))]})]}),n&&e.jsx("p",{className:"text-xs text-gray-600",children:"El activo fue preseleccionado desde el inventario de activos"}),e.jsx(d,{})]})}),e.jsx(t,{control:i.control,name:"location",render:({field:a})=>e.jsxs(o,{children:[e.jsxs(c,{className:"flex items-center gap-2",children:["UbicaciÃ³n EspecÃ­fica",n&&e.jsx("span",{className:"text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded",children:"Incluye coordenadas"})]}),e.jsx(l,{children:e.jsx(p,{placeholder:"Ej: Ãrea de juegos infantiles",...a,readOnly:!!n,className:n?"bg-gray-50 cursor-not-allowed":""})}),n&&e.jsx("p",{className:"text-xs text-gray-600",children:"La ubicaciÃ³n se cargÃ³ automÃ¡ticamente del activo con coordenadas precisas"}),e.jsx(d,{})]})})]}),e.jsx(t,{control:i.control,name:"description",render:({field:a})=>e.jsxs(o,{children:[e.jsx(c,{children:"DescripciÃ³n Detallada"}),e.jsx(l,{children:e.jsx(ee,{placeholder:"Describe la incidencia con el mayor detalle posible...",className:"min-h-[100px]",...a})}),e.jsx(d,{})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(t,{control:i.control,name:"reportedBy",render:({field:a})=>e.jsxs(o,{children:[e.jsx(c,{children:"Reportado Por"}),e.jsx(l,{children:e.jsx(p,{placeholder:"Nombre del responsable",...a})}),e.jsx(d,{})]})}),e.jsx(t,{control:i.control,name:"contactInfo",render:({field:a})=>e.jsxs(o,{children:[e.jsx(c,{children:"InformaciÃ³n de Contacto"}),e.jsx(l,{children:e.jsx(p,{placeholder:"Email o telÃ©fono",...a})}),e.jsx(d,{})]})})]}),e.jsxs("div",{children:[e.jsx(ae,{children:"Fecha de la Incidencia"}),e.jsx("div",{className:"mt-2",children:e.jsx(se,{mode:"single",selected:T,onSelect:a=>a&&k(a),className:"rounded-md border w-fit"})})]}),e.jsxs("div",{className:"flex gap-4 pt-4",children:[e.jsx(w,{type:"button",variant:"outline",onClick:()=>v("/admin/incidents"),children:"Cancelar"}),e.jsxs(w,{type:"submit",disabled:N.isPending,className:"flex items-center gap-2",children:[e.jsx(ne,{className:"h-4 w-4"}),N.isPending?"Guardando...":"Crear Incidencia"]})]})]})})]})]})]})})};export{de as default};

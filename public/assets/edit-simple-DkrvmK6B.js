import{c6 as B,a4 as R,j as e,b9 as K,ba as z,bb as Y,cS as Q,cT as G,k as H,l as J,u as X,aA as Z,R as _,ar as W,bh as ee,L as V,B as S,A as ae,aI as se,bk as re,bl as ie,bm as w,aw as L,M as O,a as $,bn as P,f as k,g as A,h as F,ad as I,i as E,aJ as l,aK as c,aL as t,aM as d,V as j,aN as m,W as U,Y as q,_ as D,$ as M,a0 as f,a1 as ne,q as oe,X as le,cp as ce,ay as o,aB as te,cU as C}from"./index-BKCBrrzQ.js";delete B.Icon.Default.prototype._getIconUrl;B.Icon.Default.mergeOptions({iconRetinaUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png",iconUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png"});function de({onLocationSelect:i}){return Q({click:h=>{const{lat:p,lng:s}=h.latlng;i({lat:p,lng:s})}}),null}function me({latitude:i,longitude:h}){const p=G();return R.useEffect(()=>{if(i&&h){const s=parseFloat(i),v=parseFloat(h);!isNaN(s)&&!isNaN(v)&&s!==0&&v!==0&&p.setView([s,v],15)}},[p,i,h]),null}function ue({latitude:i,longitude:h,defaultCenter:p,selectedLocation:s,onLocationSelect:v,className:r}){const[N,y]=R.useState(null);return R.useEffect(()=>{if(p&&!isNaN(p.lat)&&!isNaN(p.lng))y([p.lat,p.lng]);else if(i&&h){const a=parseFloat(i),u=parseFloat(h);!isNaN(a)&&!isNaN(u)?y([a,u]):y([19.4326,-99.1332])}else y([19.4326,-99.1332])},[i,h,p]),N?e.jsxs("div",{className:`relative ${r}`,children:[e.jsx("div",{className:"mb-2 text-sm text-gray-600",children:"Haz clic en el mapa para seleccionar la ubicaciÃ³n del parque"}),e.jsx("div",{style:{height:"400px",width:"100%"},className:"rounded-lg overflow-hidden border",children:e.jsxs(K,{center:N,zoom:15,style:{height:"100%",width:"100%"},scrollWheelZoom:!0,children:[e.jsx(z,{attribution:'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}),e.jsx(de,{onLocationSelect:v}),e.jsx(me,{latitude:i,longitude:h}),s&&!isNaN(s.lat)&&!isNaN(s.lng)&&e.jsx(Y,{position:[s.lat,s.lng]})]})}),s&&e.jsxs("div",{className:"mt-2 text-xs text-gray-500",children:["Coordenadas seleccionadas: ",s.lat.toFixed(6),", ",s.lng.toFixed(6)]})]}):e.jsx("div",{className:"h-64 bg-gray-200 rounded-lg flex items-center justify-center",children:"Cargando mapa..."})}const xe=o.object({name:o.string().min(1,"El nombre es requerido"),municipalityName:o.string().optional(),description:o.string().optional(),address:o.string().optional(),postalCode:o.string().optional(),contactPhone:o.string().optional(),contactEmail:o.string().optional(),parkType:o.string().optional(),latitude:o.string().optional(),longitude:o.string().optional(),area:o.string().optional(),greenArea:o.string().optional(),foundationYear:o.number().optional(),administrator:o.string().optional(),conservationStatus:o.string().optional(),certificaciones:o.array(o.string()).optional(),regulationUrl:o.string().optional(),videoUrl:o.string().optional(),schedule:o.any().optional()});function je(){const{id:i}=H(),{toast:h}=J(),p=["Green Flag Award"],{data:s,isLoading:v}=X({queryKey:[`/api/parks/${i}`],enabled:!!i}),r=Z({resolver:te(xe),defaultValues:{name:"",municipalityName:"",description:"",address:"",postalCode:"",contactPhone:"",contactEmail:"",parkType:"",latitude:"",longitude:"",area:"",greenArea:"",foundationYear:void 0,administrator:"",conservationStatus:"",certificaciones:[],regulationUrl:"",videoUrl:"",schedule:{monday:{enabled:!0,openTime:"06:00",closeTime:"22:00"},tuesday:{enabled:!0,openTime:"06:00",closeTime:"22:00"},wednesday:{enabled:!0,openTime:"06:00",closeTime:"22:00"},thursday:{enabled:!0,openTime:"06:00",closeTime:"22:00"},friday:{enabled:!0,openTime:"06:00",closeTime:"22:00"},saturday:{enabled:!0,openTime:"06:00",closeTime:"22:00"},sunday:{enabled:!0,openTime:"06:00",closeTime:"22:00"}}}});_.useEffect(()=>{var a,u,T,n;if(s){const x=g=>{const b={monday:{enabled:!0,openTime:"06:00",closeTime:"22:00"},tuesday:{enabled:!0,openTime:"06:00",closeTime:"22:00"},wednesday:{enabled:!0,openTime:"06:00",closeTime:"22:00"},thursday:{enabled:!0,openTime:"06:00",closeTime:"22:00"},friday:{enabled:!0,openTime:"06:00",closeTime:"22:00"},saturday:{enabled:!0,openTime:"06:00",closeTime:"22:00"},sunday:{enabled:!0,openTime:"06:00",closeTime:"22:00"}};if(!g)return b;try{return JSON.parse(g)}catch{return b}};r.reset({name:s.name||"",municipalityName:((a=s.municipality)==null?void 0:a.name)||"",description:s.description||"",address:s.address||"",postalCode:s.postalCode||"",contactPhone:s.contactPhone||"",contactEmail:s.contactEmail||"",parkType:s.parkType||"",latitude:((u=s.latitude)==null?void 0:u.toString())||"",longitude:((T=s.longitude)==null?void 0:T.toString())||"",area:((n=s.area)==null?void 0:n.toString())||"",greenArea:s.greenArea||"",foundationYear:s.foundationYear||void 0,administrator:s.administrator||"",conservationStatus:s.conservationStatus||"",certificaciones:(()=>{if(console.log("ğŸ” PARK ID:",s.id,"- Procesando certificaciones:",s.certificaciones,typeof s.certificaciones),!s.certificaciones||s.certificaciones===null||s.certificaciones===void 0)return console.log("âœ… PARK ID:",s.id,"- Certificaciones nulas, devolviendo array vacÃ­o"),[];if(Array.isArray(s.certificaciones))return console.log("âœ… PARK ID:",s.id,"- Certificaciones como array:",s.certificaciones),s.certificaciones;if(typeof s.certificaciones=="string"&&s.certificaciones.trim()){const g=s.certificaciones.split(", ").filter(b=>b.trim());return console.log("âœ… PARK ID:",s.id,"- Certificaciones como string dividido:",g),g}return console.log("âœ… PARK ID:",s.id,"- Certificaciones fallback a array vacÃ­o"),[]})(),regulationUrl:s.regulationUrl||"",videoUrl:s.videoUrl||"",schedule:x(s.openingHours)||{}})}},[s,r]);const N=W({mutationFn:async a=>{console.log("=== ACTUALIZANDO PARQUE ==="),console.log("Datos a enviar:",a);const{schedule:u,municipalityName:T,...n}=a,x={...n,openingHours:u?JSON.stringify(u):"{}",foundationYear:n.foundationYear||null,certificaciones:Array.isArray(n.certificaciones)?n.certificaciones.join(", "):n.certificaciones||""};console.log("Datos procesados a enviar:",x);const g=await fetch(`/api/dev/parks/${i}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:localStorage.getItem("token")?`Bearer ${localStorage.getItem("token")}`:"Bearer direct-token-1750522117022","X-User-Id":"1","X-User-Role":"super_admin"},body:JSON.stringify(x),credentials:"include"});if(!g.ok){const b=await g.text();throw new Error(`Error ${g.status}: ${b}`)}return g.json()},onSuccess:a=>{console.log("âœ… PARQUE ACTUALIZADO - Invalidando cache y recargando datos..."),C.invalidateQueries({queryKey:["/api/parks"]}),C.invalidateQueries({queryKey:[`/api/parks/${i}`]}),C.invalidateQueries({queryKey:[`/api/parks/${i}/details`]}),setTimeout(()=>{C.refetchQueries({queryKey:[`/api/parks/${i}`]})},100),h({title:"âœ… Parque actualizado exitosamente",description:"Todos los cambios han sido guardados correctamente. La pÃ¡gina se actualizarÃ¡ automÃ¡ticamente.",variant:"default"}),setTimeout(()=>{window.location.href=`/admin/parks/${i}/view`},2e3)},onError:a=>{console.error("Error al actualizar:",a),h({title:"Error",description:`Error al actualizar el parque: ${a.message}`,variant:"destructive"})}}),y=a=>{if(console.log("=== FORM SUBMIT INICIADO ==="),console.log("Park ID:",i),console.log("Form values recibidos:",a),console.log("Form state errors:",r.formState.errors),console.log("Form state isValid:",r.formState.isValid),console.log("Form state isSubmitting:",r.formState.isSubmitting),console.log("updateParkMutation.isPending:",N.isPending),console.log("Certificaciones procesadas:",a.certificaciones),Object.keys(r.formState.errors).length>0){console.error("âŒ Formulario con errores:",r.formState.errors),h({title:"Error de validaciÃ³n",description:"Por favor revisa los campos del formulario",variant:"destructive"});return}console.log("âœ… Formulario vÃ¡lido, ejecutando mutaciÃ³n..."),N.mutate(a)};return v?e.jsx("div",{children:"Cargando..."}):s?e.jsx(ee,{title:"Editar Parque",subtitle:s==null?void 0:s.name,children:e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsx("div",{className:"mb-6",children:e.jsx("div",{className:"flex items-center gap-4 mb-4",children:e.jsx(V,{href:`/admin/parks/${i}/view`,children:e.jsxs(S,{variant:"ghost",size:"sm",children:[e.jsx(ae,{className:"mr-2 h-4 w-4"}),"Volver al parque"]})})})}),e.jsx(se,{...r,children:e.jsxs("form",{onSubmit:r.handleSubmit(y),className:"space-y-6",children:[e.jsxs(re,{defaultValue:"basic",className:"space-y-6",children:[e.jsxs(ie,{className:"grid w-full grid-cols-3",children:[e.jsxs(w,{value:"basic",className:"flex items-center gap-2",children:[e.jsx(L,{className:"h-4 w-4"}),"InformaciÃ³n BÃ¡sica"]}),e.jsxs(w,{value:"location",className:"flex items-center gap-2",children:[e.jsx(O,{className:"h-4 w-4"}),"UbicaciÃ³n y Contacto"]}),e.jsxs(w,{value:"characteristics",className:"flex items-center gap-2",children:[e.jsx($,{className:"h-4 w-4"}),"CaracterÃ­sticas"]})]}),e.jsx(P,{value:"basic",children:e.jsxs(k,{children:[e.jsxs(A,{children:[e.jsxs(F,{className:"flex items-center gap-2",children:[e.jsx(L,{className:"h-5 w-5"}),"InformaciÃ³n General"]}),e.jsx(I,{children:"Datos bÃ¡sicos del parque"})]}),e.jsxs(E,{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(l,{control:r.control,name:"name",render:({field:a})=>e.jsxs(c,{children:[e.jsx(t,{children:"Nombre del Parque"}),e.jsx(d,{children:e.jsx(j,{placeholder:"Nombre del parque",...a})}),e.jsx(m,{})]})}),e.jsx(l,{control:r.control,name:"parkType",render:({field:a})=>e.jsxs(c,{children:[e.jsx(t,{children:"Tipo de Parque"}),e.jsxs(U,{onValueChange:a.onChange,value:a.value,children:[e.jsx(d,{children:e.jsx(q,{children:e.jsx(D,{placeholder:"Seleccione un tipo"})})}),e.jsxs(M,{children:[e.jsx(f,{value:"Urbano",children:"Parque Urbano"}),e.jsx(f,{value:"Metropolitano",children:"Parque Metropolitano"}),e.jsx(f,{value:"Linear",children:"Parque Linear"}),e.jsx(f,{value:"Comunitario",children:"Parque Comunitario"}),e.jsx(f,{value:"Natural",children:"Parque Natural"}),e.jsx(f,{value:"TemÃ¡tico",children:"Parque TemÃ¡tico"})]})]}),e.jsx(m,{})]})}),e.jsx(l,{control:r.control,name:"municipalityName",render:({field:a})=>e.jsxs(c,{children:[e.jsx(t,{children:"Municipio"}),e.jsx(d,{children:e.jsx(j,{placeholder:"Nombre del municipio",...a})}),e.jsx(m,{})]})})]}),e.jsx(l,{control:r.control,name:"description",render:({field:a})=>e.jsxs(c,{children:[e.jsx(t,{children:"DescripciÃ³n"}),e.jsx(d,{children:e.jsx(ne,{placeholder:"DescripciÃ³n del parque...",className:"min-h-32",...a})}),e.jsx(m,{})]})})]})]})}),e.jsx(P,{value:"location",children:e.jsxs(k,{children:[e.jsxs(A,{children:[e.jsxs(F,{className:"flex items-center gap-2",children:[e.jsx(O,{className:"h-5 w-5"}),"UbicaciÃ³n y Contacto"]}),e.jsx(I,{children:"InformaciÃ³n de ubicaciÃ³n y datos de contacto"})]}),e.jsxs(E,{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(l,{control:r.control,name:"address",render:({field:a})=>e.jsxs(c,{children:[e.jsx(t,{children:"DirecciÃ³n"}),e.jsx(d,{children:e.jsx(j,{placeholder:"DirecciÃ³n completa",...a})}),e.jsx(m,{})]})}),e.jsx(l,{control:r.control,name:"postalCode",render:({field:a})=>e.jsxs(c,{children:[e.jsx(t,{children:"CÃ³digo Postal"}),e.jsx(d,{children:e.jsx(j,{placeholder:"CÃ³digo postal",...a})}),e.jsx(m,{})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(l,{control:r.control,name:"contactPhone",render:({field:a})=>e.jsxs(c,{children:[e.jsx(t,{children:"TelÃ©fono"}),e.jsx(d,{children:e.jsx(j,{placeholder:"NÃºmero de telÃ©fono",...a})}),e.jsx(m,{})]})}),e.jsx(l,{control:r.control,name:"contactEmail",render:({field:a})=>e.jsxs(c,{children:[e.jsx(t,{children:"Email"}),e.jsx(d,{children:e.jsx(j,{type:"email",placeholder:"correo@ejemplo.com",...a})}),e.jsx(m,{})]})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"text-lg font-medium",children:"Coordenadas"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(l,{control:r.control,name:"latitude",render:({field:a})=>e.jsxs(c,{children:[e.jsx(t,{children:"Latitud"}),e.jsx(d,{children:e.jsx(j,{placeholder:"20.123456",...a})}),e.jsx(m,{})]})}),e.jsx(l,{control:r.control,name:"longitude",render:({field:a})=>e.jsxs(c,{children:[e.jsx(t,{children:"Longitud"}),e.jsx(d,{children:e.jsx(j,{placeholder:"-103.123456",...a})}),e.jsx(m,{})]})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Seleccionar ubicaciÃ³n en mapa"}),e.jsx(ue,{latitude:r.watch("latitude"),longitude:r.watch("longitude"),selectedLocation:r.watch("latitude")&&r.watch("longitude")?{lat:parseFloat(r.watch("latitude")||"0"),lng:parseFloat(r.watch("longitude")||"0")}:null,onLocationSelect:a=>{r.setValue("latitude",a.lat.toString()),r.setValue("longitude",a.lng.toString())}})]})]})]})]})}),e.jsx(P,{value:"characteristics",children:e.jsxs(k,{children:[e.jsxs(A,{children:[e.jsxs(F,{className:"flex items-center gap-2",children:[e.jsx($,{className:"h-5 w-5"}),"CaracterÃ­sticas del Parque"]}),e.jsx(I,{children:"InformaciÃ³n adicional y caracterÃ­sticas especÃ­ficas"})]}),e.jsxs(E,{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(l,{control:r.control,name:"area",render:({field:a})=>e.jsxs(c,{children:[e.jsx(t,{children:"Ãrea Total (mÂ²)"}),e.jsx(d,{children:e.jsx(j,{placeholder:"Ãrea en metros cuadrados",...a})}),e.jsx(m,{})]})}),e.jsx(l,{control:r.control,name:"greenArea",render:({field:a})=>e.jsxs(c,{children:[e.jsx(t,{children:"Ãrea Verde"}),e.jsx(d,{children:e.jsx(j,{placeholder:"DescripciÃ³n del Ã¡rea verde",...a})}),e.jsx(m,{})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(l,{control:r.control,name:"foundationYear",render:({field:a})=>e.jsxs(c,{children:[e.jsx(t,{children:"AÃ±o de FundaciÃ³n"}),e.jsx(d,{children:e.jsx(j,{type:"number",placeholder:"2024",...a,onChange:u=>a.onChange(u.target.value?parseInt(u.target.value):void 0)})}),e.jsx(m,{})]})}),e.jsx(l,{control:r.control,name:"administrator",render:({field:a})=>e.jsxs(c,{children:[e.jsx(t,{children:"Administrador"}),e.jsx(d,{children:e.jsx(j,{placeholder:"Nombre del administrador",...a})}),e.jsx(m,{})]})})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:e.jsx(l,{control:r.control,name:"conservationStatus",render:({field:a})=>e.jsxs(c,{children:[e.jsx(t,{children:"Estado de ConservaciÃ³n"}),e.jsxs(U,{onValueChange:a.onChange,value:a.value,children:[e.jsx(d,{children:e.jsx(q,{children:e.jsx(D,{placeholder:"Seleccione estado"})})}),e.jsxs(M,{children:[e.jsx(f,{value:"Excelente",children:"Excelente"}),e.jsx(f,{value:"Bueno",children:"Bueno"}),e.jsx(f,{value:"Regular",children:"Regular"}),e.jsx(f,{value:"Malo",children:"Malo"}),e.jsx(f,{value:"CrÃ­tico",children:"CrÃ­tico"})]})]}),e.jsx(m,{})]})})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(l,{control:r.control,name:"regulationUrl",render:({field:a})=>e.jsxs(c,{children:[e.jsx(t,{children:"URL de RegulaciÃ³n"}),e.jsx(d,{children:e.jsx(j,{placeholder:"https://ejemplo.com/regulacion",...a})}),e.jsx(m,{})]})}),e.jsx(l,{control:r.control,name:"videoUrl",render:({field:a})=>e.jsxs(c,{children:[e.jsx(t,{children:"URL de Video"}),e.jsx(d,{children:e.jsx(j,{placeholder:"https://youtube.com/watch?v=...",...a})}),e.jsx(m,{})]})})]}),e.jsx(l,{control:r.control,name:"certificaciones",render:({field:a})=>{const u=n=>{var x;(x=a.value)!=null&&x.includes(n)||a.onChange([...a.value||[],n])},T=n=>{var x;a.onChange(((x=a.value)==null?void 0:x.filter(g=>g!==n))||[])};return e.jsxs(c,{children:[e.jsx(t,{children:"Certificaciones"}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"space-y-2",children:e.jsxs(U,{onValueChange:u,children:[e.jsx(d,{children:e.jsx(q,{children:e.jsx(D,{placeholder:"Seleccionar certificaciÃ³n"})})}),e.jsx(M,{children:p.map(n=>{var x;return e.jsx(f,{value:n,disabled:(x=a.value)==null?void 0:x.includes(n),children:n},n)})})]})}),a.value&&a.value.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("span",{className:"text-sm font-medium",children:"Certificaciones asignadas al parque:"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:a.value.map((n,x)=>e.jsxs(oe,{variant:"default",className:"flex items-center gap-1 bg-green-100 text-green-800 hover:bg-green-200",children:[n,e.jsx(le,{className:"h-3 w-3 cursor-pointer hover:text-red-600",onClick:()=>T(n)})]},x))})]})]}),e.jsx(m,{}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Selecciona las certificaciones del parque."})]})}})]})]})})]}),e.jsxs("div",{className:"flex justify-end gap-4",children:[e.jsx(V,{href:`/admin/parks/${i}/view`,children:e.jsx(S,{variant:"outline",children:"Cancelar"})}),e.jsx(S,{type:"submit",disabled:N.isPending,className:"min-w-32 bg-green-600 hover:bg-green-700 text-white",onClick:async a=>{console.log("ğŸ”˜ BOTÃ“N GUARDAR PRESIONADO - Park ID:",i),console.log("ğŸ”˜ Form state valid:",r.formState.isValid),console.log("ğŸ”˜ Form errors:",r.formState.errors),console.log("ğŸ”˜ Form values before submit:",r.getValues());const u=await r.trigger();if(console.log("ğŸ” Manual validation result:",u),console.log("ğŸ” Form errors after trigger:",r.formState.errors),!u){console.error("âŒ FORM INVALID - Previniendo submit"),a.preventDefault();return}console.log("âœ… FORM VALID - Permitiendo submit")},children:N.isPending?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Guardando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ce,{className:"mr-2 h-4 w-4"}),"Guardar Cambios"]})})]})]})})]})}):e.jsx("div",{children:"Parque no encontrado"})}export{je as default};

import{u as L,j as e,b7 as q,bi as b,f as c,g as o,h as d,U as E,i as x,bB as J,a2 as Z,bj as ee,bc as N,by as se,bq as P,br as T,bg as w,bz as K,bd as te,be as ae,bf as re,q as ie,n as ne,bt as le}from"./index-BKCBrrzQ.js";import{B as ce}from"./BarChart-CGQMqZFp.js";function me(){const{data:h=[],isLoading:R}=L({queryKey:["/api/visitor-counts"],retry:1}),{data:l=[],isLoading:O}=L({queryKey:["/api/feedback"],queryFn:async()=>{const t=await fetch("/api/feedback?limit=1000");if(!t.ok)throw new Error("Failed to fetch feedback");return t.json()},retry:1}),B=R||O,a=(h==null?void 0:h.data)||h||[],u=(l==null?void 0:l.feedback)||(l==null?void 0:l.data)||l||[],y=Array.isArray(a)?a.reduce((t,s)=>t+(s.adults||0)+(s.children||0)+(s.seniors||0),0):0,F=Array.isArray(u)?u.length:0,M=Array.isArray(a)?a.reduce((t,s)=>t+(s.adults||0),0):0,W=Array.isArray(a)?a.reduce((t,s)=>t+(s.children||0),0):0,$=Array.isArray(a)?a.reduce((t,s)=>t+(s.seniors||0),0):0,v=[{name:"Adultos",count:M,color:"#00a587"},{name:"Niños",count:W,color:"#00d4aa"},{name:"Adultos Mayores",count:$,color:"#067f5f"}],j=v.reduce((t,s)=>s.count>t.count?s:t,v[0]),D=y>0?j.count/y*100:0,A=t=>{const s=new Date(t),r=s.getDay(),i=s.getDate()-r+(r===0?-6:1);return new Date(s.setDate(i))},G=t=>{const s=A(t),r=new Date(s);return r.setDate(s.getDate()+6),r},k=new Date,g=A(k),f=G(k),I=Array.isArray(a)?a.filter(t=>{if(!t.date)return!1;const s=new Date(t.date);return s>=g&&s<=f}).reduce((t,s)=>t+(s.adults||0)+(s.children||0)+(s.seniors||0),0):0,S=Array.isArray(a)?a.filter(t=>{if(!t.date)return!1;const s=new Date(t.date);return s>=g&&s<=f}).reduce((t,s)=>{const r=s.parkName||"Parque Desconocido",i=(s.adults||0)+(s.children||0)+(s.seniors||0);return t[r]=(t[r]||0)+i,t},{}):{},p=Object.entries(S).length>0?Object.entries(S).reduce((t,[s,r])=>r>t.visitors?{name:s,visitors:r}:t,{name:"",visitors:0}):{name:"Sin datos",visitors:0},U=Array.isArray(a)?a.reduce((t,s)=>{const r=s.countingMethod||"Directo";return t[r]=(t[r]||0)+((s.adults||0)+(s.children||0)+(s.seniors||0)),t},{}):{},z=Object.entries(U).map(([t,s])=>({method:t,count:s})),C=Array.isArray(a)?[{name:"Adultos",value:a.reduce((t,s)=>t+(s.adults||0),0),color:"#00a587"},{name:"Niños",value:a.reduce((t,s)=>t+(s.children||0),0),color:"#00d4aa"},{name:"Adultos Mayores",value:a.reduce((t,s)=>t+(s.seniors||0),0),color:"#067f5f"}]:[],H=Array.isArray(a)?a.reduce((t,s)=>{const r=s.parkName||`Parque ${s.parkId}`;return t[r]||(t[r]=0),t[r]+=(s.adults||0)+(s.children||0)+(s.seniors||0),t},{}):{},Q=Object.entries(H).map(([t,s])=>({name:t,visitors:s})).sort((t,s)=>s.visitors-t.visitors).slice(0,5),X=Array.isArray(a)?(()=>{const t=new Date,s=[];for(let r=6;r>=0;r--){const i=new Date(t);i.setDate(t.getDate()-r);const V=i.toISOString().split("T")[0],Y=a.filter(n=>n.date===V).reduce((n,m)=>n+(m.adults||0)+(m.children||0)+(m.seniors||0),0),_=Array.isArray(u)?u.filter(n=>{try{return new Date(n.created_at||n.createdAt).toISOString().split("T")[0]===V}catch{return!1}}).length:0;try{s.push({date:i.toLocaleDateString("es-ES",{weekday:"short",day:"numeric"}),visitors:Y,feedback:_})}catch(n){console.error("Error processing date:",i,n)}}return s})():[];return B?e.jsx(q,{icon:b,title:"Visitantes",subtitle:"Vista consolidada de visitantes y retroalimentación",children:e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Cargando datos del dashboard..."})]})})}):e.jsx(q,{icon:b,title:"Visitantes",subtitle:"Vista consolidada de visitantes y retroalimentación",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:[e.jsxs(c,{children:[e.jsxs(o,{className:"flex flex-row items-center justify-between pb-2",children:[e.jsx(d,{className:"text-sm font-medium text-gray-600",children:"Total Visitantes"}),e.jsx(E,{className:"h-4 w-4 text-blue-600"})]}),e.jsxs(x,{children:[e.jsx("div",{className:"text-2xl font-bold text-gray-900",children:y.toLocaleString()}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Registros históricos"}),e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"text-gray-600",children:["Grupo dominante: ",j.name]}),e.jsxs("span",{className:"font-medium",style:{color:j.color},children:[D.toFixed(1),"%"]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"h-2 rounded-full transition-all duration-300 ease-in-out",style:{width:`${D}%`,backgroundColor:j.color}})})]})]})]}),e.jsxs(c,{children:[e.jsxs(o,{className:"flex flex-row items-center justify-between pb-2",children:[e.jsx(d,{className:"text-sm font-medium text-gray-600",children:"Visitantes Semanales"}),e.jsx(J,{className:"h-4 w-4 text-orange-600"})]}),e.jsxs(x,{children:[e.jsx("div",{className:"text-2xl font-bold text-gray-900",children:I.toLocaleString()}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Semana actual (",g.toLocaleDateString("es-ES",{day:"numeric",month:"short"})," - ",f.toLocaleDateString("es-ES",{day:"numeric",month:"short"}),")"]}),p.visitors>0&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-600",children:"Parque líder:"}),e.jsx("span",{className:"font-medium text-orange-700",children:p.name})]}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[p.visitors.toLocaleString()," visitantes"]})]})]})]}),e.jsxs(c,{children:[e.jsxs(o,{className:"flex flex-row items-center justify-between pb-2",children:[e.jsx(d,{className:"text-sm font-medium text-gray-600",children:"Retroalimentación"}),e.jsx(Z,{className:"h-4 w-4 text-green-600"})]}),e.jsxs(x,{children:[e.jsx("div",{className:"text-2xl font-bold text-gray-900",children:F}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Comentarios ciudadanos"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(c,{children:[e.jsx(o,{children:e.jsxs(d,{className:"flex items-center gap-2",children:[e.jsx(ee,{className:"h-5 w-5 text-blue-600"}),"Tendencias (Últimos 7 días)"]})}),e.jsx(x,{children:e.jsx(N,{width:"100%",height:300,children:e.jsxs(se,{data:X,children:[e.jsx(P,{dataKey:"date"}),e.jsx(T,{}),e.jsx(w,{}),e.jsx(K,{type:"monotone",dataKey:"visitors",stroke:"#00a587",strokeWidth:2,name:"Visitantes"}),e.jsx(K,{type:"monotone",dataKey:"feedback",stroke:"#10b981",strokeWidth:2,name:"Feedback"})]})})})]}),e.jsxs(c,{children:[e.jsx(o,{children:e.jsxs(d,{className:"flex items-center gap-2",children:[e.jsx(E,{className:"h-5 w-5 text-purple-600"}),"Distribución Demográfica"]})}),e.jsx(x,{children:e.jsx(N,{width:"100%",height:300,children:e.jsxs(te,{children:[e.jsx(ae,{data:C,cx:"50%",cy:"50%",outerRadius:80,dataKey:"value",label:({name:t,percent:s})=>`${t}: ${(s*100).toFixed(0)}%`,children:C.map((t,s)=>e.jsx(re,{fill:t.color},`cell-${s}`))}),e.jsx(w,{})]})})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(c,{children:[e.jsx(o,{children:e.jsxs(d,{className:"flex items-center gap-2",children:[e.jsx(b,{className:"h-5 w-5 text-green-600"}),"Top Parques por Visitantes"]})}),e.jsx(x,{children:e.jsx("div",{className:"space-y-3",children:Q.map((t,s)=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ie,{variant:"secondary",className:"w-6 h-6 p-0 flex items-center justify-center text-xs",children:s+1}),e.jsx("span",{className:"text-sm font-medium",children:t.name})]}),e.jsxs("span",{className:"text-sm text-gray-600",children:[t.visitors.toLocaleString()," visitantes"]})]},t.name))})})]}),e.jsxs(c,{children:[e.jsx(o,{children:e.jsxs(d,{className:"flex items-center gap-2",children:[e.jsx(ne,{className:"h-5 w-5 text-orange-600"}),"Métodos de Registro"]})}),e.jsx(x,{children:e.jsx(N,{width:"100%",height:250,children:e.jsxs(ce,{data:z,children:[e.jsx(P,{dataKey:"method"}),e.jsx(T,{}),e.jsx(w,{}),e.jsx(le,{dataKey:"count",fill:"#00a587"})]})})})]})]})]})})}export{me as default};

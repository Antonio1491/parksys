import{dE as R,dF as K,dG as l,dH as p,dI as g,dJ as P,dK as U,dL as Z,dM as B,b6 as ae,d9 as de,da as m,dN as f,dO as z,dP as $,aH as ue,l as me,az as xe,a4 as V,aA as he,aB as je,u as T,R as pe,ar as ge,j as e,bh as ve,B as G,A as Ne,aI as be,f as q,g as D,h as w,ce as ye,ad as k,i as L,aJ as i,aK as r,aL as t,aM as o,V as x,aN as c,W as C,Y as S,_ as A,$ as I,a0 as j,a1 as ee,M as fe,aQ as J,b9 as Ce,ba as Se,ak as Ae,n as Ie,cp as _e,cT as Me,cS as qe,bb as De,aC as we}from"./index-BKCBrrzQ.js";import{H as Le}from"./Helmet-B2HBtdJj.js";const Ve=R("asset_categories",{id:K("id").primaryKey(),name:l("name").notNull().unique(),description:l("description"),icon:l("icon"),color:l("color"),parentId:p("parent_id"),createdAt:g("created_at").notNull().defaultNow(),updatedAt:g("updated_at").notNull().defaultNow()}),Ee=R("assets",{id:K("id").primaryKey(),name:l("name").notNull(),description:l("description"),serialNumber:l("serial_number"),categoryId:p("category_id").notNull(),parkId:p("park_id").notNull(),amenityId:p("amenity_id"),locationDescription:l("location_description"),latitude:l("latitude"),longitude:l("longitude"),acquisitionDate:P("acquisition_date"),acquisitionCost:U("acquisition_cost",{precision:10,scale:2}),currentValue:U("current_value",{precision:10,scale:2}),manufacturer:l("manufacturer"),model:l("model"),status:l("status").notNull().default("active"),condition:l("condition").notNull().default("good"),maintenanceFrequency:l("maintenance_frequency"),lastMaintenanceDate:P("last_maintenance_date"),nextMaintenanceDate:P("next_maintenance_date"),expectedLifespan:p("expected_lifespan"),notes:l("notes"),qrCode:l("qr_code"),responsiblePersonId:p("responsible_person_id"),photos:l("photos").array(),documents:l("documents").array(),createdAt:g("created_at").notNull().defaultNow(),updatedAt:g("updated_at").notNull().defaultNow()}),Fe=R("asset_maintenances",{id:K("id").primaryKey(),assetId:p("asset_id").notNull(),maintenanceType:l("maintenance_type").notNull(),date:P("date").notNull(),description:l("description").notNull(),estimatedCost:U("estimated_cost",{precision:10,scale:2}),actualCost:U("actual_cost",{precision:10,scale:2}),priority:l("priority").notNull().default("medium"),assignedToId:p("assigned_to_id"),notes:l("notes"),findings:l("findings"),actions:l("actions"),completionNotes:l("completion_notes"),photos:l("photos").array(),status:l("status").notNull().default("scheduled"),completedAt:g("completed_at"),createdAt:g("created_at").notNull().defaultNow(),updatedAt:g("updated_at").notNull().defaultNow()}),Te=R("asset_history",{id:K("id").primaryKey(),assetId:p("asset_id").notNull(),changeType:l("change_type").notNull(),date:g("date").notNull().defaultNow(),description:l("description").notNull(),changedBy:p("changed_by").notNull(),previousValue:Z("previous_value"),newValue:Z("new_value"),notes:l("notes"),createdAt:g("created_at").notNull().defaultNow()});B(Ve).omit({id:!0,createdAt:!0,updatedAt:!0});B(Ee).omit({id:!0,createdAt:!0,updatedAt:!0});B(Fe).omit({id:!0,createdAt:!0,updatedAt:!0});B(Te).omit({id:!0,createdAt:!0});const ke=[{value:"excellent",label:"Excelente"},{value:"good",label:"Bueno"},{value:"fair",label:"Regular"},{value:"poor",label:"Malo"}],Pe=[{value:"active",label:"Activo"},{value:"maintenance",label:"En Mantenimiento"},{value:"damaged",label:"Dañado"},{value:"retired",label:"Retirado"}],Ue=[{value:"daily",label:"Diario"},{value:"weekly",label:"Semanal"},{value:"monthly",label:"Mensual"},{value:"quarterly",label:"Trimestral"},{value:"biannual",label:"Semestral"},{value:"yearly",label:"Anual"}];delete ae.Icon.Default.prototype._getIconUrl;ae.Icon.Default.mergeOptions({iconRetinaUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png",iconUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png"});const Re=de({name:m().min(1,"El nombre es obligatorio"),description:m().nullable().optional(),serialNumber:m().nullable().optional(),categoryId:f().min(1,"La categoría es obligatoria"),parkId:f().min(1,"El parque es obligatorio"),amenityId:f().nullable().optional(),locationDescription:m().nullable().optional(),latitude:m().nullable().optional(),longitude:m().nullable().optional(),acquisitionDate:m().nullable().optional(),acquisitionCost:z([f().positive(),$()]).transform(d=>isNaN(d)?null:d).nullable().optional(),currentValue:z([f().positive(),$()]).transform(d=>isNaN(d)?null:d).nullable().optional(),manufacturer:m().nullable().optional(),model:m().nullable().optional(),status:m().min(1,"El estado es obligatorio"),condition:m().min(1,"La condición es obligatoria"),maintenanceFrequency:m().nullable().optional(),lastMaintenanceDate:m().nullable().optional(),nextMaintenanceDate:m().nullable().optional(),expectedLifespan:z([f().positive(),$()]).transform(d=>isNaN(d)?null:d).nullable().optional(),notes:m().nullable().optional(),qrCode:m().nullable().optional(),responsiblePersonId:f().nullable().optional()});function Ke({center:d}){const v=Me();return V.useEffect(()=>{d&&v.setView(d,16)},[d,v]),null}function Be({position:d,onLocationSelect:v}){return qe({click(_){v(_.latlng.lat,_.latlng.lng)}}),d?e.jsx(De,{position:d}):null}const $e=()=>{const[d,v]=ue(),{toast:_}=me(),W=xe(),[H,ne]=V.useState(null),[E,Y]=V.useState(null),s=he({resolver:je(Re),defaultValues:{name:"",description:"",serialNumber:"",categoryId:0,parkId:0,amenityId:null,locationDescription:"",latitude:"",longitude:"",acquisitionDate:new Date().toISOString().split("T")[0],acquisitionCost:null,currentValue:null,manufacturer:"",model:"",status:"active",condition:"good",maintenanceFrequency:null,lastMaintenanceDate:"",nextMaintenanceDate:"",expectedLifespan:null,notes:"",qrCode:"",responsiblePersonId:null}}),{data:N,isLoading:se}=T({queryKey:["/api/asset-categories/tree/structure"]}),F=pe.useMemo(()=>{if(!N)return[];const a=[];return N.forEach(n=>{a.push(n),n.children&&n.children.forEach(u=>{a.push(u)})}),a},[N]),le=a=>{if(!F||F.length===0)return"";const n=F.find(u=>u.id===a);if(!n)return"";if(n.parentId){const u=F.find(ce=>ce.id===n.parentId);return u?`${u.name} → ${n.name}`:n.name}return n.name},{data:h,isLoading:te}=T({queryKey:["/api/parks"]}),b=s.watch("parkId"),{data:y,isLoading:He}=T({queryKey:[`/api/parks/${b}/amenities`],enabled:!!b&&b>0}),{data:O,isLoading:Oe}=T({queryKey:["/api/users"]});V.useEffect(()=>{if(b&&b>0&&(s.setValue("amenityId",null),s.setValue("locationDescription",""),h)){const n=(Array.isArray(h)?h:(h==null?void 0:h.data)||[]).find(u=>u.id===b);if(n&&n.latitude&&n.longitude){const u=[parseFloat(n.latitude),parseFloat(n.longitude)];ne(u),Y(null),s.setValue("latitude",""),s.setValue("longitude","")}}},[b,s,h]);const ie=(a,n)=>{Y([a,n]),s.setValue("latitude",a.toString()),s.setValue("longitude",n.toString())},M=s.watch("amenityId");V.useEffect(()=>{if(M&&M!==null&&y&&Array.isArray(y)){const a=y.find(n=>n.id===M);if(a){const n=a.moduleName?`${a.amenityName} - ${a.moduleName}`:a.amenityName;s.setValue("locationDescription",n||"")}}else M===null&&s.setValue("locationDescription","")},[M,y,s]);const Q=ge({mutationFn:a=>we("/api/assets-direct",{method:"POST",data:a}),onSuccess:a=>{W.invalidateQueries({queryKey:["/api/assets"]}),W.invalidateQueries({queryKey:["/api/asset-categories"]}),_({title:"Activo creado",description:"El activo se ha creado correctamente."}),v("/admin/assets")},onError:a=>{_({title:"Error",description:"Ha ocurrido un error al crear el activo.",variant:"destructive"}),console.error("Error al crear activo:",a)}}),X=()=>{v("/admin/assets")},re=a=>{Q.mutate(a)},oe=!se&&!te&&N&&h;return e.jsxs(ve,{children:[e.jsxs(Le,{children:[e.jsx("title",{children:"Crear Nuevo Activo | Bosques Urbanos"}),e.jsx("meta",{name:"description",content:"Formulario para registrar un nuevo activo en el sistema."})]}),e.jsx("div",{className:"flex justify-between items-center mb-6",children:e.jsxs("div",{className:"flex items-center",children:[e.jsxs(G,{variant:"outline",onClick:X,className:"mr-4",children:[e.jsx(Ne,{className:"mr-2 h-4 w-4"}),"Volver"]}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Crear Nuevo Activo"}),e.jsx("p",{className:"text-muted-foreground",children:"Complete el formulario para registrar un nuevo activo en el sistema."})]})]})}),oe?e.jsx(be,{...s,children:e.jsxs("form",{onSubmit:s.handleSubmit(re),className:"space-y-6",children:[e.jsxs(q,{children:[e.jsxs(D,{children:[e.jsxs(w,{className:"flex items-center gap-2",children:[e.jsx(ye,{className:"h-5 w-5"}),"Información Básica"]}),e.jsx(k,{children:"Información general del activo"})]}),e.jsxs(L,{children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsx(i,{control:s.control,name:"name",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Nombre*"}),e.jsx(o,{children:e.jsx(x,{placeholder:"Nombre del activo",...a})}),e.jsx(c,{})]})}),e.jsx(i,{control:s.control,name:"serialNumber",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Número de Serie"}),e.jsx(o,{children:e.jsx(x,{placeholder:"Número de serie o código",...a,value:a.value||""})}),e.jsx(c,{})]})}),e.jsx(i,{control:s.control,name:"categoryId",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Categoría*"}),e.jsx(o,{children:e.jsxs(C,{value:a.value?a.value.toString():"",onValueChange:n=>a.onChange(parseInt(n)),children:[e.jsx(S,{children:e.jsx(A,{placeholder:"Seleccione una categoría"})}),e.jsx(I,{children:N&&Array.isArray(N)?N.map(n=>[e.jsx(j,{value:n.id.toString(),children:e.jsx("span",{className:"font-semibold text-gray-900",children:n.name})},n.id),...n.children&&n.children.length>0?n.children.map(u=>e.jsx(j,{value:u.id.toString(),children:e.jsxs("span",{className:"text-gray-600 ml-4",children:["↳ ",u.name]})},u.id)):[]]).flat():null})]})}),a.value&&a.value>0&&e.jsxs("div",{className:"text-sm text-gray-600 mt-2 p-2 bg-gray-50 rounded-md",children:[e.jsx("span",{className:"font-medium",children:"Categoría seleccionada:"})," ",le(a.value)]}),e.jsx(c,{})]})}),e.jsx(i,{control:s.control,name:"manufacturer",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Fabricante"}),e.jsx(o,{children:e.jsx(x,{placeholder:"Marca o fabricante",...a,value:a.value||""})}),e.jsx(c,{})]})}),e.jsx(i,{control:s.control,name:"model",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Modelo"}),e.jsx(o,{children:e.jsx(x,{placeholder:"Modelo del activo",...a,value:a.value||""})}),e.jsx(c,{})]})}),e.jsx(i,{control:s.control,name:"status",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Estado*"}),e.jsx(o,{children:e.jsxs(C,{value:a.value,onValueChange:a.onChange,children:[e.jsx(S,{children:e.jsx(A,{placeholder:"Seleccione un estado"})}),e.jsx(I,{children:Pe.map(n=>e.jsx(j,{value:n.value,children:n.label},n.value))})]})}),e.jsx(c,{})]})}),e.jsx(i,{control:s.control,name:"condition",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Condición*"}),e.jsx(o,{children:e.jsxs(C,{value:a.value,onValueChange:a.onChange,children:[e.jsx(S,{children:e.jsx(A,{placeholder:"Seleccione una condición"})}),e.jsx(I,{children:ke.map(n=>e.jsx(j,{value:n.value,children:n.label},n.value))})]})}),e.jsx(c,{})]})}),e.jsx(i,{control:s.control,name:"qrCode",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Código QR"}),e.jsx(o,{children:e.jsx(x,{placeholder:"URL o código QR",...a,value:a.value||""})}),e.jsx(c,{})]})})]}),e.jsx("div",{className:"mt-4",children:e.jsx(i,{control:s.control,name:"description",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Descripción"}),e.jsx(o,{children:e.jsx(ee,{placeholder:"Descripción detallada del activo",...a,value:a.value||""})}),e.jsx(c,{})]})})})]})]}),e.jsxs(q,{children:[e.jsxs(D,{children:[e.jsxs(w,{className:"flex items-center gap-2",children:[e.jsx(fe,{className:"h-5 w-5"}),"Ubicación"]}),e.jsx(k,{children:"Ubicación física del activo"})]}),e.jsx(L,{children:e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsx(i,{control:s.control,name:"parkId",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Parque*"}),e.jsx(o,{children:e.jsxs(C,{value:a.value?a.value.toString():"",onValueChange:n=>{const u=parseInt(n);a.onChange(u),s.setValue("amenityId",null),s.setValue("locationDescription","")},children:[e.jsx(S,{children:e.jsx(A,{placeholder:"Seleccione un parque"})}),e.jsx(I,{children:h&&Array.isArray(h)?h.map(n=>e.jsx(j,{value:n.id.toString(),children:n.name},n.id)):null})]})}),e.jsx(c,{})]})}),e.jsx(i,{control:s.control,name:"amenityId",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Amenidad (Opcional)"}),e.jsx(o,{children:e.jsxs(C,{value:a.value?a.value.toString():"",onValueChange:n=>{n===""||n==="none"?a.onChange(null):a.onChange(parseInt(n))},children:[e.jsx(S,{children:e.jsx(A,{placeholder:"Seleccione una amenidad"})}),e.jsxs(I,{className:"z-[1001]",children:[e.jsx(j,{value:"none",children:"Sin amenidad específica"}),y&&Array.isArray(y)?y.filter(n=>n.id&&n.amenityName).map(n=>e.jsxs(j,{value:n.id.toString(),children:[n.amenityName," - ",n.moduleName||"Módulo general"]},n.id)):null]})]})}),e.jsx(J,{children:"Si se selecciona, la ubicación se llenará automáticamente"}),e.jsx(c,{})]})}),e.jsx(i,{control:s.control,name:"locationDescription",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Descripción de Ubicación"}),e.jsx(o,{children:e.jsx(x,{placeholder:"Ubicación específica dentro del parque",...a,value:a.value||""})}),e.jsx(J,{children:"Se llena automáticamente si selecciona una amenidad"}),e.jsx(c,{})]})}),e.jsx(i,{control:s.control,name:"responsiblePersonId",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Responsable"}),e.jsx(o,{children:e.jsxs(C,{value:a.value?a.value.toString():"",onValueChange:n=>a.onChange(n?parseInt(n):null),children:[e.jsx(S,{children:e.jsx(A,{placeholder:"Seleccione un responsable"})}),e.jsxs(I,{className:"z-[1001]",children:[e.jsx(j,{value:"none",children:"Sin responsable asignado"}),O&&Array.isArray(O)?O.map(n=>e.jsxs(j,{value:n.id.toString(),children:[n.username," (",n.role,")"]},n.id)):null]})]})}),e.jsx(c,{})]})}),e.jsx(i,{control:s.control,name:"latitude",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Latitud"}),e.jsx(o,{children:e.jsx(x,{placeholder:"Coordenada de latitud",...a,value:a.value||""})}),e.jsx(c,{})]})}),e.jsx(i,{control:s.control,name:"longitude",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Longitud"}),e.jsx(o,{children:e.jsx(x,{placeholder:"Coordenada de longitud",...a,value:a.value||""})}),e.jsx(c,{})]})}),H&&e.jsxs("div",{className:"col-span-2",children:[e.jsx(t,{children:"Ubicación en el mapa"}),e.jsx(J,{className:"mb-2",children:"Haz clic en el mapa para seleccionar la ubicación exacta del activo"}),e.jsx("div",{className:"h-64 w-full border rounded-md overflow-hidden",children:e.jsxs(Ce,{center:H,zoom:16,style:{height:"100%",width:"100%"},children:[e.jsx(Se,{url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}),e.jsx(Ke,{center:H}),e.jsx(Be,{position:E,onLocationSelect:ie})]})}),E&&e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:["Ubicación seleccionada: ",E[0].toFixed(6),", ",E[1].toFixed(6)]})]})]})})]}),e.jsxs(q,{children:[e.jsxs(D,{children:[e.jsxs(w,{className:"flex items-center gap-2",children:[e.jsx(Ae,{className:"h-5 w-5"}),"Información Financiera"]}),e.jsx(k,{children:"Datos económicos y de valoración del activo"})]}),e.jsx(L,{children:e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsx(i,{control:s.control,name:"acquisitionDate",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Fecha de Adquisición"}),e.jsx(o,{children:e.jsx(x,{type:"date",...a,value:a.value||""})}),e.jsx(c,{})]})}),e.jsx(i,{control:s.control,name:"expectedLifespan",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Vida Útil (meses)"}),e.jsx(o,{children:e.jsx(x,{type:"number",placeholder:"Vida útil esperada en meses",...a,value:a.value===null?"":a.value,onChange:n=>a.onChange(n.target.value===""?null:parseInt(n.target.value))})}),e.jsx(c,{})]})}),e.jsx(i,{control:s.control,name:"acquisitionCost",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Costo de Adquisición"}),e.jsx(o,{children:e.jsx(x,{type:"number",step:"0.01",placeholder:"Costo en pesos",...a,value:a.value===null?"":a.value,onChange:n=>a.onChange(n.target.value===""?null:parseFloat(n.target.value))})}),e.jsx(c,{})]})}),e.jsx(i,{control:s.control,name:"currentValue",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Valor Actual"}),e.jsx(o,{children:e.jsx(x,{type:"number",step:"0.01",placeholder:"Valor actual después de depreciación",...a,value:a.value===null?"":a.value,onChange:n=>a.onChange(n.target.value===""?null:parseFloat(n.target.value))})}),e.jsx(c,{})]})})]})})]}),e.jsxs(q,{children:[e.jsxs(D,{children:[e.jsxs(w,{className:"flex items-center gap-2",children:[e.jsx(Ie,{className:"h-5 w-5"}),"Mantenimiento"]}),e.jsx(k,{children:"Programación y seguimiento de mantenimiento"})]}),e.jsx(L,{children:e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsx(i,{control:s.control,name:"maintenanceFrequency",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Frecuencia de Mantenimiento"}),e.jsx(o,{children:e.jsxs(C,{value:a.value||"",onValueChange:n=>a.onChange(n||null),children:[e.jsx(S,{children:e.jsx(A,{placeholder:"Seleccione frecuencia"})}),e.jsxs(I,{children:[e.jsx(j,{value:"none",children:"Sin mantenimiento programado"}),Ue.map(n=>e.jsx(j,{value:n.value,children:n.label},n.value))]})]})}),e.jsx(c,{})]})}),e.jsx("div",{className:"md:col-span-1"}),e.jsx(i,{control:s.control,name:"lastMaintenanceDate",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Último Mantenimiento"}),e.jsx(o,{children:e.jsx(x,{type:"date",...a,value:a.value||""})}),e.jsx(c,{})]})}),e.jsx(i,{control:s.control,name:"nextMaintenanceDate",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Próximo Mantenimiento"}),e.jsx(o,{children:e.jsx(x,{type:"date",...a,value:a.value||""})}),e.jsx(c,{})]})})]})})]}),e.jsxs(q,{children:[e.jsx(D,{children:e.jsx(w,{children:"Notas Adicionales"})}),e.jsx(L,{children:e.jsx(i,{control:s.control,name:"notes",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Notas"}),e.jsx(o,{children:e.jsx(ee,{placeholder:"Información adicional sobre el activo...",...a,value:a.value||"",rows:4})}),e.jsx(c,{})]})})})]}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(G,{type:"button",variant:"outline",onClick:X,children:"Cancelar"}),e.jsxs(G,{type:"submit",className:"gap-1",disabled:Q.isPending,children:[e.jsx(_e,{className:"h-4 w-4"}),Q.isPending?"Guardando...":"Guardar Activo"]})]})]})}):e.jsx("div",{className:"py-8 text-center text-muted-foreground",children:e.jsx("p",{children:"Cargando información necesaria..."})})]})};export{$e as default};

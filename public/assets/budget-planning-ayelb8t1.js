import{a4 as x,l as q,az as H,u as K,ar as Q,j as e,du as S,bh as X,f as u,i as g,cb as W,y as Z,z as ee,B as j,b0 as re,I as se,J as te,K as ae,bH as oe,bL as ne,bJ as le,bM as ce,F as ie,D as de,W as me,Y as xe,_ as he,$ as pe,a0 as be,cp as ue,g as y,h as f,bj as ge,V as Y}from"./index-BKCBrrzQ.js";import{T as je}from"./trending-down-CPeGf22o.js";const d=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];function Ne(){const[l,_]=x.useState(new Date().getFullYear()),[a,E]=x.useState(null),[U,I]=x.useState(!1),[A,N]=x.useState(!1),[v,P]=x.useState(null),[D,F]=x.useState([]),{toast:m}=q(),L=H(),{data:T,isLoading:O,refetch:G}=K({queryKey:["budget-projections",l],queryFn:async()=>{const r=await fetch(`/api/budget-projections/${l}`);if(!r.ok)throw new Error("Error al cargar datos presupuestarios");return r.json()}}),C=Q({mutationFn:async r=>{const s=await fetch(`/api/budget-projections/${r.year}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({matrix:r.matrix})});if(!s.ok)throw new Error("Error al guardar proyecciones");return s.json()},onSuccess:()=>{m({title:"âœ“ Proyecciones Guardadas",description:`Presupuesto del ${l} guardado correctamente`}),I(!1),L.invalidateQueries({queryKey:["budget-projections",l]})},onError:()=>{m({title:"Error al Guardar",description:"No se pudieron guardar las proyecciones",variant:"destructive"})}});x.useEffect(()=>{T&&E(T)},[T]);const V=(r,s,t,o)=>{if(!a)return;const c=parseFloat(t)||0,i={...a},b=o==="income"?i.incomeCategories:i.expenseCategories,h=b.findIndex(p=>p.categoryId===r);h!==-1&&(b[h].months[s]=c,b[h].totalYear=Object.values(b[h].months).reduce((p,w)=>p+(w||0),0),k(i),E(i),I(!0))},k=r=>{r.yearlyTotals={income:0,expense:0,net:0},r.monthlyTotals={income:{},expense:{},net:{}};for(let s=1;s<=12;s++)r.monthlyTotals.income[s]=0,r.monthlyTotals.expense[s]=0,r.monthlyTotals.net[s]=0;r.incomeCategories.forEach(s=>{r.yearlyTotals.income+=s.totalYear;for(let t=1;t<=12;t++)r.monthlyTotals.income[t]+=s.months[t]||0}),r.expenseCategories.forEach(s=>{r.yearlyTotals.expense+=s.totalYear;for(let t=1;t<=12;t++)r.monthlyTotals.expense[t]+=s.months[t]||0}),r.yearlyTotals.net=r.yearlyTotals.income-r.yearlyTotals.expense;for(let s=1;s<=12;s++)r.monthlyTotals.net[s]=r.monthlyTotals.income[s]-r.monthlyTotals.expense[s]},R=()=>{a&&(k(a),C.mutate({year:l,matrix:a}))},B=r=>{var t;const s=(t=r.target.files)==null?void 0:t[0];if(s&&s.type==="text/csv"){P(s);const o=new FileReader;o.onload=c=>{var p;const h=((p=c.target)==null?void 0:p.result).split(`
`).slice(0,5).map(w=>w.split(","));F(h)},o.readAsText(s)}else m({title:"Archivo InvÃ¡lido",description:"Por favor selecciona un archivo CSV vÃ¡lido",variant:"destructive"})},z=async()=>{if(v)try{const r=new FormData;r.append("file",v),r.append("year",l.toString());const s=await fetch("/api/budget-projections/import-csv",{method:"POST",body:r});if(!s.ok)throw new Error("Error al importar CSV");const t=await s.json();m({title:"âœ“ ImportaciÃ³n Exitosa",description:`Se importaron ${t.recordsImported} registros presupuestarios`}),G(),N(!1),P(null),F([])}catch{m({title:"Error al Importar",description:"No se pudo procesar el archivo CSV",variant:"destructive"})}},J=async()=>{try{const r=await fetch(`/api/budget-projections/${l}/export-csv`);if(!r.ok)throw new Error("Error al exportar");const s=await r.text(),t=new Blob([s],{type:"text/csv"}),o=URL.createObjectURL(t),c=document.createElement("a");c.href=o,c.download=`presupuesto_${l}.csv`,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(o),m({title:"âœ“ ExportaciÃ³n Exitosa",description:`Presupuesto del ${l} exportado en formato CSV`})}catch{m({title:"Error al Exportar",description:"No se pudo exportar el archivo",variant:"destructive"})}},n=r=>new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN",minimumFractionDigits:0,maximumFractionDigits:0}).format(r),M=r=>r>0?r.toLocaleString("es-MX"):"",$=r=>parseFloat(r.replace(/,/g,""))||0;return O?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsxs("div",{className:"text-center",children:[e.jsx(S,{className:"h-8 w-8 animate-spin mx-auto mb-4 text-[#00a587]"}),e.jsx("p",{className:"text-gray-600",children:"Cargando matriz presupuestaria..."})]})}):e.jsx(X,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsx(u,{className:"bg-gray-50",children:e.jsx(g,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(W,{className:"w-8 h-8 text-black"}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"PlanificaciÃ³n Presupuestaria"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"Define las proyecciones mensuales por categorÃ­a de ingresos y gastos"})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(Z,{open:A,onOpenChange:N,children:[e.jsx(ee,{asChild:!0,children:e.jsxs(j,{variant:"outline",className:"bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100",children:[e.jsx(re,{className:"h-4 w-4 mr-2"}),"Importar CSV"]})}),e.jsxs(se,{className:"max-w-2xl",children:[e.jsx(te,{children:e.jsx(ae,{children:"Importar Datos Presupuestarios desde CSV"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Seleccionar archivo CSV"}),e.jsx("input",{type:"file",accept:".csv",onChange:B,className:"block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-[#00a587] file:text-white hover:file:bg-[#067f5f]"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Formato esperado: CategorÃ­a, Tipo, Enero, Febrero, ..., Diciembre"})]}),D.length>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"Vista previa del archivo:"}),e.jsx("div",{className:"border rounded max-h-40 overflow-auto",children:e.jsx(oe,{children:e.jsx(ne,{children:D.map((r,s)=>e.jsx(le,{children:r.map((t,o)=>e.jsx(ce,{className:"text-xs px-2 py-1",children:t},o))},s))})})})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(j,{variant:"outline",onClick:()=>N(!1),children:"Cancelar"}),e.jsxs(j,{onClick:z,disabled:!v,className:"bg-[#00a587] hover:bg-[#067f5f]",children:[e.jsx(ie,{className:"h-4 w-4 mr-2"}),"Importar Datos"]})]})]})]})]}),e.jsxs(j,{variant:"outline",onClick:J,className:"bg-green-50 border-green-200 text-green-700 hover:bg-green-100",children:[e.jsx(de,{className:"h-4 w-4 mr-2"}),"Exportar CSV"]}),e.jsxs(me,{value:l.toString(),onValueChange:r=>_(parseInt(r)),children:[e.jsx(xe,{className:"w-32",children:e.jsx(he,{})}),e.jsx(pe,{children:Array.from({length:5},(r,s)=>{const t=new Date().getFullYear()+s-1;return e.jsx(be,{value:t.toString(),children:t},t)})})]}),e.jsxs(j,{onClick:R,disabled:!U||C.isPending,className:"bg-[#00a587] hover:bg-[#067f5f]",children:[e.jsx(ue,{className:"h-4 w-4 mr-2"}),C.isPending?"Guardando...":"Guardar Presupuesto"]})]})]})})}),a&&e.jsxs("div",{className:"grid md:grid-cols-3 gap-4",children:[e.jsxs(u,{children:[e.jsx(y,{className:"pb-3",children:e.jsxs(f,{className:"text-sm font-medium flex items-center",children:[e.jsx(ge,{className:"h-4 w-4 mr-2 text-green-600"}),"Ingresos Proyectados"]})}),e.jsx(g,{children:e.jsx("div",{className:"text-2xl font-bold text-green-600",children:n(a.yearlyTotals.income)})})]}),e.jsxs(u,{children:[e.jsx(y,{className:"pb-3",children:e.jsxs(f,{className:"text-sm font-medium flex items-center",children:[e.jsx(je,{className:"h-4 w-4 mr-2 text-red-600"}),"Gastos Proyectados"]})}),e.jsx(g,{children:e.jsx("div",{className:"text-2xl font-bold text-red-600",children:n(a.yearlyTotals.expense)})})]}),e.jsxs(u,{children:[e.jsx(y,{className:"pb-3",children:e.jsxs(f,{className:"text-sm font-medium flex items-center",children:[e.jsx(S,{className:"h-4 w-4 mr-2"}),"Utilidad / PÃ©rdida Proyectada"]})}),e.jsx(g,{children:e.jsx("div",{className:`text-2xl font-bold ${a.yearlyTotals.net>=0?"text-green-600":"text-red-600"}`,children:n(a.yearlyTotals.net)})})]})]}),a&&e.jsxs(u,{children:[e.jsx(y,{children:e.jsxs(f,{className:"flex items-center",children:[e.jsx(S,{className:"h-5 w-5 mr-2"}),"Matriz de PlanificaciÃ³n ",l]})}),e.jsx(g,{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse border border-gray-200",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50",children:[e.jsx("th",{className:"border border-gray-200 p-3 text-left font-medium",children:"CategorÃ­a"}),d.map(r=>e.jsx("th",{className:"border border-gray-200 p-3 text-center font-medium min-w-[120px]",children:r},r)),e.jsx("th",{className:"border border-gray-200 p-3 text-center font-medium bg-gray-100",children:"Total Anual"})]})}),e.jsxs("tbody",{children:[e.jsx("tr",{className:"bg-green-50",children:e.jsxs("td",{colSpan:14,className:"border border-gray-200 p-3 font-semibold text-green-800",children:["ðŸ“ˆ Ingresos Proyectados ",l]})}),a.incomeCategories.map(r=>e.jsxs("tr",{className:"hover:bg-green-25",children:[e.jsx("td",{className:"border border-gray-200 p-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full",style:{backgroundColor:r.categoryColor}}),r.categoryName]})}),d.map((s,t)=>{const o=t+1;return e.jsx("td",{className:"border border-gray-200 p-2",children:e.jsx(Y,{type:"text",value:M(r.months[o]||0),onChange:c=>{const i=$(c.target.value);V(r.categoryId,o,i.toString(),"income")},className:"text-center border-0 bg-transparent focus:bg-white",placeholder:"0"})},o)}),e.jsx("td",{className:"border border-gray-200 p-3 text-center font-semibold bg-green-50",children:n(r.totalYear)})]},`income-${r.categoryId}`)),e.jsxs("tr",{className:"bg-green-100 font-semibold",children:[e.jsx("td",{className:"border border-gray-200 p-3",children:"Totales"}),d.map((r,s)=>{const t=s+1;return e.jsx("td",{className:"border border-gray-200 p-3 text-center",children:n(a.monthlyTotals.income[t]||0)},t)}),e.jsx("td",{className:"border border-gray-200 p-3 text-center bg-green-200",children:n(a.yearlyTotals.income)})]}),e.jsx("tr",{className:"bg-red-50",children:e.jsxs("td",{colSpan:14,className:"border border-gray-200 p-3 font-semibold text-red-800",children:["ðŸ“‰ Gastos Proyectados ",l]})}),a.expenseCategories.map(r=>e.jsxs("tr",{className:"hover:bg-red-25",children:[e.jsx("td",{className:"border border-gray-200 p-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full",style:{backgroundColor:r.categoryColor}}),r.categoryName]})}),d.map((s,t)=>{const o=t+1;return e.jsx("td",{className:"border border-gray-200 p-2",children:e.jsx(Y,{type:"text",value:M(r.months[o]||0),onChange:c=>{const i=$(c.target.value);V(r.categoryId,o,i.toString(),"expense")},className:"text-center border-0 bg-transparent focus:bg-white",placeholder:"0"})},o)}),e.jsx("td",{className:"border border-gray-200 p-3 text-center font-semibold bg-red-50",children:n(r.totalYear)})]},`expense-${r.categoryId}`)),e.jsxs("tr",{className:"bg-red-100 font-semibold",children:[e.jsx("td",{className:"border border-gray-200 p-3",children:"Totales"}),d.map((r,s)=>{const t=s+1;return e.jsx("td",{className:"border border-gray-200 p-3 text-center",children:n(a.monthlyTotals.expense[t]||0)},t)}),e.jsx("td",{className:"border border-gray-200 p-3 text-center bg-red-200",children:n(a.yearlyTotals.expense)})]}),e.jsx("tr",{className:"bg-blue-50",children:e.jsxs("td",{colSpan:14,className:"border border-gray-200 p-3 font-semibold text-blue-800",children:["ðŸ’° Utilidad / PÃ©rdida por Mes ",l]})}),e.jsxs("tr",{className:"bg-blue-100 font-semibold",children:[e.jsx("td",{className:"border border-gray-200 p-3",children:"Ingresos"}),d.map((r,s)=>{const t=s+1;return e.jsx("td",{className:"border border-gray-200 p-3 text-center text-green-700",children:n(a.monthlyTotals.income[t]||0)},t)}),e.jsx("td",{className:"border border-gray-200 p-3 text-center text-green-700 bg-green-100",children:n(a.yearlyTotals.income)})]}),e.jsxs("tr",{className:"bg-blue-100 font-semibold",children:[e.jsx("td",{className:"border border-gray-200 p-3",children:"Gastos"}),d.map((r,s)=>{const t=s+1;return e.jsx("td",{className:"border border-gray-200 p-3 text-center text-red-700",children:n(a.monthlyTotals.expense[t]||0)},t)}),e.jsx("td",{className:"border border-gray-200 p-3 text-center text-red-700 bg-red-100",children:n(a.yearlyTotals.expense)})]}),e.jsxs("tr",{className:"bg-blue-200 font-bold",children:[e.jsx("td",{className:"border border-gray-200 p-3",children:"Utilidad / PÃ©rdida"}),d.map((r,s)=>{const t=s+1,o=a.monthlyTotals.net[t]||0;return e.jsx("td",{className:`border border-gray-200 p-3 text-center ${o>=0?"text-green-700":"text-red-700"}`,children:n(o)},t)}),e.jsx("td",{className:`border border-gray-200 p-3 text-center font-bold ${a.yearlyTotals.net>=0?"text-green-700 bg-green-200":"text-red-700 bg-red-200"}`,children:n(a.yearlyTotals.net)})]})]})]})})})]})]})})}export{Ne as default};
